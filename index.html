<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Стикер-PDF Fix</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; }
    body{margin:0;font:15px/1.4 system-ui,Segoe UI,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:14px 18px;background:#0b1220;position:sticky;top:0;z-index:5;border-bottom:1px solid #1f2937}
    h1{margin:0;font-size:17px}
    .wrap{max-width:1000px;margin:0 auto;padding:14px}
    .row{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:800px){.row{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:14px;box-shadow:0 8px 20px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:15px}
    textarea{width:100%;padding:8px;border-radius:10px;border:1px solid #30363d;background:#0d1322;color:#e5e7eb;min-height:70px}
    .btn{background:var(--accent);color:#00111f;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .drop{border:2px dashed #374151;border-radius:14px;padding:16px;text-align:center;color:#9ca3af}
    .drop.drag{border-color:#60a5fa;background:rgba(96,165,250,.06)}
    .small{font-size:12px;color:#9ca3af}
    .preview{max-height:280px;overflow:auto;border:1px dashed #374151;border-radius:12px;padding:6px;background:#0b1220;text-align:center}
    .footer{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:6px 10px;color:#9ca3af;font-size:12px}
    canvas{max-width:100%;height:auto}
  </style>
</head>
<body>
<header>
  <h1>Стикер-PDF Fix — замена «Изготовитель» (GitHub Pages, без сервера)</h1>
</header>
<div class="wrap">
  <div class="row">
    <section class="card">
      <h2>1) Загрузите PDF-стикеры</h2>
      <div id="drop" class="drop">Перетащите PDF сюда или <label for="file" style="color:#60a5fa;cursor:pointer">выберите…</label>
        <input id="file" type="file" accept="application/pdf" multiple style="display:none" />
      </div>
      <h2 style="margin-top:14px">2) Новый текст</h2>
      <textarea id="text">Изготовитель: Guangzhou Anrong Trading Co., Ltd. Китай, Room 2310A, 23F, No. 179, Tianhe North Road, Tianhe District, Guangzhou</textarea>
      <div class="footer">
        <button id="run" class="btn" disabled>Обработать и скачать ZIP</button>
        <span id="status" class="pill">Файлы не загружены</span>
      </div>
    </section>
    <aside class="card">
      <h2>Предпросмотр</h2>
      <div id="preview" class="preview">Пока пусто…</div>
    </aside>
  </div>
  <section class="card" style="margin-top:14px">
    <h2>Результат</h2>
    <div id="result" class="preview"></div>
    <div class="footer">
      <a id="dlZip" class="btn" download style="display:none">Скачать ZIP</a>
      <span class="pill">Работает прямо в браузере. Подходит для GitHub Pages.</span>
    </div>
  </section>
</div>

<!-- libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js"></script>
<script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
<script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
const $=s=>document.querySelector(s);
const drop=$('#drop'),fileInput=$('#file'),runBtn=$('#run'),statusEl=$('#status'),preview=$('#preview'),result=$('#result'),textEl=$('#text'),dlZip=$('#dlZip');
let files=[];

;['dragenter','dragover'].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.add('drag');}));
;['dragleave','drop'].forEach(e=>drop.addEventListener(e,ev=>{ev.preventDefault();drop.classList.remove('drag');}));
drop.addEventListener('drop',e=>{files=[...e.dataTransfer.files].filter(f=>f.type==='application/pdf');onFiles();});
fileInput.addEventListener('change',e=>{files=[...e.target.files].filter(f=>f.type==='application/pdf');onFiles();});

function onFiles(){
  if(files.length){statusEl.textContent=`Выбрано: ${files.length}`;runBtn.disabled=false;makePreview(files[0]);}
  else{statusEl.textContent='Файлы не загружены';runBtn.disabled=true;preview.innerHTML='Пока пусто…';}}

async function makePreview(file){
  const arr=await file.arrayBuffer();
  const pdf=await pdfjsLib.getDocument({data:arr}).promise;
  const page=await pdf.getPage(1);
  const viewport=page.getViewport({scale:0.8});
  const canvas=document.createElement('canvas');
  const ctx=canvas.getContext('2d');
  canvas.width=viewport.width;canvas.height=viewport.height;
  await page.render({canvasContext:ctx,viewport}).promise;
  preview.innerHTML='';preview.appendChild(canvas);
}

runBtn.addEventListener('click',async()=>{
  result.textContent='Работаю…';
  const zip=new JSZip();
  const fontBytes=await fetch('https://raw.githubusercontent.com/google/fonts/main/apache/arial/Arial-Regular.ttf').then(r=>r.arrayBuffer()).catch(()=>null);
  for(const f of files){
    const inBytes=new Uint8Array(await f.arrayBuffer());
    const pdfDoc=await PDFLib.PDFDocument.load(inBytes);
    const font= fontBytes? await pdfDoc.embedFont(fontBytes): await pdfDoc.embedFont(PDFLib.StandardFonts.Helvetica);
    for(const page of pdfDoc.getPages()){
      const {width,height}=page.getSize();
      page.drawRectangle({x:50,y:height-200,width:width*0.6,height:60,color:PDFLib.rgb(1,1,1)});
      page.drawText(textEl.value,{x:52,y:height-190,size:7,font,color:PDFLib.rgb(0,0,0)});
    }
    const outBytes=await pdfDoc.save();
    zip.file(f.name.replace(/\.pdf$/i,'_edited.pdf'),outBytes);
  }
  const zipBlob=await zip.generateAsync({type:'blob'});
  const url=URL.createObjectURL(zipBlob);
  dlZip.href=url;dlZip.download='edited_stickers.zip';dlZip.style.display='inline-block';
  result.innerHTML='Готово: скачайте ZIP';
});
</script>
</body>
</html>
